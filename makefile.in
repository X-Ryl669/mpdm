# -*- Mode: sh

TARGET=libmpdm.a
LIB=$(TARGET)

all: $(TARGET) docs

PROJ=mpdm
DOCS=doc/mpdm_api.html doc/mpdm_overview.html

OBJS=mpdm_v.o mpdm_a.o mpdm_h.o mpdm_d.o mpdm_s.o mpdm_f.o \
	mpdm_r.o gnu_regex.o

##################################################################

version:
	@echo $(VERSION)

ChangeLog:
	cvs2cl --fsf --stdout > Changelog

.c.o:
	$(CC) $(CFLAGS) `cat config.cflags` -c $<

dep:
	gcc -MM *.c > makefile.depend

$(LIB): $(OBJS)
	$(AR) rv $(LIB) $(OBJS)

stress: stress.c $(LIB)
	$(CC) $(CFLAGS) `cat config.ldflags` stress.c -L. -lmpdm -o $@

doc/index.html: doc/index.txt
	-grutatxt -i $< -o $@

doc/mpdm_overview.html: doc/mpdm_overview.txt
	-grutatxt -i $< -o $@

doc/mpdm_api.html: mpdm_*.c
	-mp_doccer mpdm_*.c -o doc/mpdm_api -f html1 \
	-t "MPDM C API ($(VERSION))" \
	-a 'Angel Ortega - angel@triptico.com'

docs: $(DOCS)

docsclean:
	rm -f doc/*.html

clean:
	rm -f $(TARGET) $(LIB) $(OBJS) *.o tags *.tar.gz stress Changelog

distclean: docs clean
	rm -f config.h config.cflags config.ldflags makefile.opts .config.log Makefile

dist: distclean ChangeLog
	cd .. ; ln -s $(PROJ) $(PROJ)-$(VERSION); \
	tar czvf $(PROJ)-$(VERSION)/$(PROJ)-$(VERSION).tar.gz --exclude=CVS $(PROJ)-$(VERSION)/* ; \
	rm $(PROJ)-$(VERSION)

.po.mo:
	msgfmt -o $@ $<

build-mo:
	for a in po/*.po ; do \
		B=`basename $$a .po` ; \
		mkdir -p po/$$B/LC_MESSAGES ; \
		msgfmt -o po/$$B/LC_MESSAGES/stress.mo $$a ; \
	done

installdoc:
	-install -m 644 $(DOCS) $(DOCDIR)
