# -*- Mode: sh

TARGET=libmpdm.a
LIB=$(TARGET)

all: $(TARGET)

PROJ=mpdm
DOCS=

OBJS=mpdm_v.o mpdm_a.o mpdm_h.o mpdm_d.o mpdm_s.o mpdm_f.o \
	mpdm_r.o gnu_regex.o

##################################################################

version:
	@echo $(VERSION)

ChangeLog:
	cvs2cl --fsf --stdout > Changelog

.c.o:
	$(CC) $(CFLAGS) `cat config.cflags` -c $<

dep:
	gcc -MM *.c > makefile.depend

$(LIB): $(OBJS)
	$(AR) rv $(LIB) $(OBJS)

stress: stress.c $(LIB)
	$(CC) $(CFLAGS) `cat config.ldflags` stress.c -L. -lmpdm -o $@

docs:
	mkdir -p doc
	-mp_doccer mpdm_*.c -o doc/mpdm_ref -f html1 \
	-t "Minimum Profit Data Manager API ($(VERSION))" \
	-a 'Angel Ortega - <em>angel@triptico.com</em>'

docsclean:
	rm -f doc/mpdm_ref.html

clean:
	rm -f $(TARGET) $(LIB) $(OBJS) *.o tags *.tar.gz stress

distclean: clean docsclean
	rm -f config.h config.cflags config.ldflags makefile.opts .config.log Makefile

dist: distclean ChangeLog docs
	cd .. ; ln -s $(PROJ) $(PROJ)-$(VERSION); \
	tar czvf $(PROJ)-$(VERSION)/$(PROJ)-$(VERSION).tar.gz --exclude=CVS $(PROJ)-$(VERSION)/* ; \
	rm $(PROJ)-$(VERSION)

install:
	install $(TARGET) $(PREFIX)/bin
	mkdir -p $(PREFIX)/share/doc/$(PROJ)
	cp $(DOCS) $(PREFIX)/share/doc/$(PROJ)

.po.mo:
	msgfmt -o $@ $<

build-mo:
	for a in po/*.po ; do \
		B=`basename $$a .po` ; \
		mkdir -p po/$$B/LC_MESSAGES ; \
		msgfmt -o po/$$B/LC_MESSAGES/stress.mo $$a ; \
	done
